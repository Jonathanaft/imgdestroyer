<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>STICKMAN SURVIVAL</title>
<style>
body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: black;
    font-family: monospace;
    color: white;
}
#gameCanvas, #stickmanCanvas {
    position: absolute;
    top: 0;
    left: 0;
}
#controls {
    display:none;
}
#timer {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 24px;
    z-index: 10;
    color: lime;
}
</style>
</head>
<body>

<div id="timer">Time: 180</div>
<canvas id="gameCanvas"></canvas>
<canvas id="stickmanCanvas" width="20" height="40"></canvas>

<input type="file" id="upload" accept="image/*">

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const stickCanvas = document.getElementById("stickmanCanvas");
const stickCtx = stickCanvas.getContext("2d");

const timerEl = document.getElementById("timer");
let img = new Image();
let imgData = null;
let fragments = [];
let attacks = [];

let stick = {x:50, y:canvas.height-60, w:20, h:40, speed:5};
let keys = {};
let gameStarted = false;
let surviveTime = 180; // seconds

document.getElementById("upload").addEventListener("change", e=>{
    const reader = new FileReader();
    reader.onload = ()=>{img.src=reader.result;};
    reader.readAsDataURL(e.target.files[0]);
});

img.onload = ()=>{
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = img.width;
    tempCanvas.height = img.height;
    const tempCtx = tempCanvas.getContext("2d");
    tempCtx.drawImage(img,0,0);
    imgData = tempCtx.getImageData(0,0,img.width,img.height);
    createFragments();
    startGame();
};

// --- Fragment monster ---
function createFragments(){
    fragments = [];
    const fragSize = 30;
    for(let y=0;y<img.height;y+=fragSize){
        for(let x=0;x<img.width;x+=fragSize){
            fragments.push({
                x: (canvas.width-img.width)/2 + x,
                y: 50 + y,
                w: fragSize, h: fragSize,
                targetX: Math.random()*canvas.width,
                targetY: Math.random()*canvas.height/3
            });
        }
    }
}

// --- Stickman ---
function drawStickman(){
    stickCtx.clearRect(0,0,stickCanvas.width,stickCanvas.height);
    stickCtx.strokeStyle = "yellow";
    stickCtx.lineWidth = 2;
    stickCtx.beginPath();
    stickCtx.arc(10,5,5,0,Math.PI*2); stickCtx.stroke();
    stickCtx.beginPath(); stickCtx.moveTo(10,10); stickCtx.lineTo(10,25); stickCtx.stroke();
    stickCtx.beginPath(); stickCtx.moveTo(10,15); stickCtx.lineTo(0,20); stickCtx.moveTo(10,15); stickCtx.lineTo(20,20); stickCtx.stroke();
    stickCtx.beginPath(); stickCtx.moveTo(10,25); stickCtx.lineTo(0,35); stickCtx.moveTo(10,25); stickCtx.lineTo(20,35); stickCtx.stroke();
    stickCanvas.style.left = stick.x + "px";
    stickCanvas.style.top = stick.y + "px";
}

// --- Controls ---
window.addEventListener("keydown", e=>{keys[e.key]=true;});
window.addEventListener("keyup", e=>{keys[e.key]=false;});

// --- Game ---
function startGame(){
    if(gameStarted) return;
    gameStarted = true;
    surviveTime = 180;
    setInterval(()=>{surviveTime--; timerEl.textContent="Time: "+surviveTime; if(surviveTime<=0) alert("YOU SURVIVED!");},1000);
    requestAnimationFrame(gameLoop);
}

// --- Attack spawn ---
function spawnAttack(){
    if(fragments.length===0) return;
    const frag = fragments[Math.floor(Math.random()*fragments.length)];
    attacks.push({
        x: frag.x, y: frag.y,
        w: frag.w, h: frag.h,
        dx: (stick.x-frag.x)/100,
        dy: (stick.y-frag.y)/100
    });
}

// --- Collision ---
function checkCollision(a,b){return a.x<a.x+b.w && a.x+ a.w> b.x && a.y<a.y+b.h && a.y+a.h> b.y;}

// --- Game Loop ---
function gameLoop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // animate monster fragments
    fragments.forEach(f=>{
        f.x += (f.targetX-f.x)*0.02;
        f.y += (f.targetY-f.y)*0.02;
        if(imgData) ctx.putImageData(getFragment(imgData,f.imgX||0,f.imgY||0,f.w,f.h),f.x,f.y);
    });

    // spawn attacks randomly
    if(Math.random()<0.05) spawnAttack();

    // move attacks
    attacks.forEach((a,i)=>{
        a.x+=a.dx*5; a.y+=a.dy*5;
        ctx.fillStyle="red"; ctx.fillRect(a.x,a.y,a.w,a.h);
        if(checkCollision(a,stick)){
            alert("YOU WERE DESTROYED!"); resetGame(); return;
        }
        // remove attacks if offscreen
        if(a.x<0||a.x>canvas.width||a.y<0||a.y>canvas.height) attacks.splice(i,1);
    });

    // stickman movement
    if(keys["ArrowUp"]||keys["w"]) stick.y -= stick.speed;
    if(keys["ArrowDown"]||keys["s"]) stick.y += stick.speed;
    if(keys["ArrowLeft"]||keys["a"]) stick.x -= stick.speed;
    if(keys["ArrowRight"]||keys["d"]) stick.x += stick.speed;
    stick.x = Math.max(0,Math.min(canvas.width-20,stick.x));
    stick.y = Math.max(0,Math.min(canvas.height-40,stick.y));
    drawStickman();

    requestAnimationFrame(gameLoop);
}

function resetGame(){
    gameStarted=false;
    fragments=[]; attacks=[]; stick.x=50; stick.y=canvas.height-60;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawStickman();
}
function getFragment(imgData,x,y,w,h){
    const temp = new ImageData(w,h);
    for(let j=0;j<h;j++){
        for(let i=0;i<w;i++){
            const idx=(j*w+i)*4;
            const srcIdx=((y+j)*imgData.width + (x+i))*4;
            temp.data[idx]=imgData.data[srcIdx];
            temp.data[idx+1]=imgData.data[srcIdx+1];
            temp.data[idx+2]=imgData.data[srcIdx+2];
            temp.data[idx+3]=255;
        }
    }
    return temp;
}

// initialize
drawStickman();
</script>
</body>
</html>
